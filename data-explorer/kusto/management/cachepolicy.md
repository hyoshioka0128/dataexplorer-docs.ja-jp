---
title: キャッシュポリシー (ホットキャッシュとコールドキャッシュ)-Azure データエクスプローラー
description: この記事では、Azure データエクスプローラーのキャッシュポリシー (ホットキャッシュとコールドキャッシュ) について説明します。
services: data-explorer
author: orspod
ms.author: orspodek
ms.reviewer: rkarlin
ms.service: data-explorer
ms.topic: reference
ms.date: 02/19/2020
ms.openlocfilehash: af224c630cb835d190b8fd6655a6d42f7fd7fee9
ms.sourcegitcommit: d79d3aa9aaa70cd23e3107ef12296159322e1eb5
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/20/2020
ms.locfileid: "86475611"
---
# <a name="cache-policy-hot-and-cold-cache"></a>キャッシュ ポリシー (ホットおよびコールド キャッシュ) 

Azure データエクスプローラーは、取り込まれたデータを reliable storage (通常 Azure Blob Storage) に格納し、実際の処理 (Azure コンピューティング) ノードから離れた場所に保存します。 そのデータに対するクエリを高速化するために、Azure データエクスプローラーはそのデータを処理ノード、SSD、または RAM にキャッシュします。 Azure データエクスプローラーには、キャッシュするデータオブジェクトを適切に決定するように設計された高度なキャッシュメカニズムが備わっています。 キャッシュを使用すると、Azure データエクスプローラーによって使用されるデータアーティファクトを記述できます。これにより、より重要なデータを優先できるようになります。 たとえば、列インデックスや列データシャードのようになります。

すべての取り込まれたデータがキャッシュされると、最適なクエリパフォーマンスが得られます。 場合によっては、特定のデータがローカル SSD ストレージでの "ウォーム" 状態を維持するコストを正当化していないことがあります。
たとえば、多くのチームでは、アクセス頻度の低い古いログレコードが重要度の低いことを検討しています。
このようなデータに対してクエリを実行する場合、パフォーマンスを低下させたいと考えています。

Azure データエクスプローラー cache は、**ホットデータキャッシュ**と**コールドデータキャッシュ**を区別するためにお客様が使用できる粒度の細かい**キャッシュポリシー**を提供します。 Azure データエクスプローラーキャッシュは、ホットデータキャッシュの定義されたサイズまで、ホットデータキャッシュカテゴリに分類されるすべてのデータをローカル SSD (または RAM) に保持しようとします。 残りのローカル SSD 領域は、ホットとして分類されていないデータを保持するために使用されます。 この設計には、信頼性の高いストレージから大量のコールドデータを読み込むクエリではホットデータキャッシュからデータが削除されないという意味があります。 このため、ホットデータキャッシュ内のデータに関連するクエリに大きな影響はありません。

ホットキャッシュポリシーを設定すると、主に次のような影響があります。
* **コスト**: ローカル SSD の場合よりも、信頼性の高いストレージのコストを大幅に下げることができます。 現時点では、Azure では約45倍のコストがかかります。
* **パフォーマンス**: ローカル SSD の場合、特に大量のデータをスキャンする範囲クエリの場合、データのクエリが高速に実行されます。  

キャッシュポリシーを管理するには、[キャッシュポリシーコマンド](cache-policy.md)を使用します。

> [!TIP]
>Azure データエクスプローラーは、中間結果セットを使用したアドホッククエリに対して、クラスターの合計 RAM 容量を調整するように設計されています。
>SSD などの永続的なストレージに中間結果を格納する、マップ削減などの大規模なジョブの場合は、連続エクスポート機能を使用します。 この機能を使用すると、HDInsight や Azure Databricks などのサービスを使用して、実行時間の長いバッチクエリを実行できます。
 
## <a name="how-cache-policy-is-applied"></a>キャッシュポリシーの適用方法

データが Azure データエクスプローラーに取り込まれたされると、システムはインジェストの日付と時刻、および作成されたエクステントを追跡します。 エクステントのインジェストの日付と時刻の値 (1 つのエクステントが既存の複数のエクステントから構築された場合の最大値) は、キャッシュポリシーを評価するために使用されます。

> [!NOTE]
> インジェストプロパティを使用して、インジェストの日付と時刻の値を指定でき `creationTime` ます。

既定では、有効なポリシーはです `null` 。これは、すべてのデータが**ホット**であると見なされることを意味します。
テーブルレベル以外のポリシーは、 `null` データベースレベルのポリシーを上書きします。

## <a name="scoping-queries-to-hot-cache"></a>クエリのスコープをホットキャッシュに

Kusto は、ホットキャッシュデータのみにスコープが設定されたクエリをサポートします。

> [!NOTE]
> データのスコープは、テーブルなどのキャッシュポリシーをサポートするエンティティにのみ適用されます。 外部テーブルなどの他のエンティティについては無視されます。

クエリにはいくつかの可能性があります。
* というクライアント要求プロパティを `query_datascope` クエリに追加します。
   使用可能な値: `default` 、 `all` 、および `hotcache` 。
* `set`クエリテキストでステートメントを使用します `set query_datascope='...'` 。
   指定できる値は、クライアント要求プロパティの値と同じです。
* `datascope=...`クエリ本文内のテーブル参照の直後にテキストを追加します。 
   設定可能な値は `all` および `hotcache` です。

値は、 `default` クラスターの既定の設定を使用して、クエリがすべてのデータを対象にする必要があることを示します。

異なるメソッド間に不一致がある場合、は、 `set` クライアント要求プロパティよりも優先されます。 テーブル参照に値を指定すると、両方の値よりも優先されます。

たとえば、次のクエリでは、すべてのデータを対象とした "T" への2番目の参照を除き、すべてのテーブル参照でホットキャッシュデータのみが使用されます。

```kusto
set query_datascope="hotcache";
T | union U | join (T datascope=all | where Timestamp < ago(365d) on X
```

## <a name="cache-policy-vs-retention-policy"></a>キャッシュポリシーと保持ポリシー

キャッシュポリシーは、[保持ポリシー](./retentionpolicy.md)に依存しません。 
- キャッシュポリシーは、リソースに優先順位を付ける方法を定義します。 重要なデータに対するクエリは、あまり重要ではないデータに対するクエリの影響に対して、より高速かつ耐性があります。
- 保持ポリシーは、テーブル/データベース内のクエリ可能なデータの範囲を定義します (具体的には `SoftDeletePeriod` )。

予想されるクエリパターンに基づいて、コストとパフォーマンスの最適なバランスを実現するために、このポリシーを構成します。

例:
* `SoftDeletePeriod`= 56d
* `hot cache policy`= 28d

この例では、過去28日間のデータがクラスター SSD に配置され、追加の28日分のデータが Azure blob ストレージに格納されます。
最大56日間のデータに対してクエリを実行できます。
 
